!function(){var t=function(t){console.log(t),this.container=t,this.askHintDOM=$("#siri_ask_hint"),this.init()};t.prototype={init:function(){this.initDOM(),this.initEvent()},show:function(t){t?(this.askHintDOM.removeClass("hidden"),this.askHintDOM.addClass("show"),this.mySwiper.startSlide&&this.mySwiper.startSlide()):(this.askHintDOM.removeClass("show"),this.askHintDOM.addClass("hidden"),this.mySwiper.stopSlide&&this.mySwiper.stopSlide())},initDOM:function(){function t(t){function e(t){var e='<div class="swiper-slide"><ul class="hint_list move_up">';return t.forEach(function(t){e+="<li>"+t+"</li>"}),e+="</ul></div>"}for(var i="",n=0;n<t.length;n++)i+=e(t[n].items);return answerDom='<div class="content"><h2>你可以这样问我:</h2><div class="swiper-container swiper-container-horizontal" id="swiper"><div class="swiper-wrapper ">'+i+'</div></div><div class="btn_change_wrapper"><span class="btn_change">换一换</span></div><div class="btn_close_wrapper"><span class="btn_close"></span></div></div>',answerDom}this.container.netConnector.askServer({type:"ASK",question:"recommend"},function(e,i){var n=null;e?n=localStorage.ASK_HINT?JSON.parse(localStorage.ASK_HINT):[{items:["600519","开户","选股","KDJ","茅台行情"]}]:(n=i.data.body,localStorage.ASK_HINT=JSON.stringify(n));var s=t(n);this.askHintDOM.html(""),this.askHintDOM.append($(s)),this.mySwiper=this.addSwiper(),this.askHintDOM.addClass("hidden")}.bind(this))},addSwiper:function(){for(var t={},e=this.askHintDOM.find(".swiper-wrapper").eq(0),i=e.find(".swiper-slide"),n=e.width(),s=0;s<i.length;s++){var a=$(i[s]);a.data("swiperSlideIndex",s),a.css({transform:"translate3d("+n*s*-1+"px, 0px, 0px)"}),a.removeClass("swiper-slide-active")}return i.length>0&&(t.activeId=0,t.swiperSlides=i,t.slideNext=function(){var e=i[t.activeId],n=(t.activeId+1)%i.length;console.log(n),e.classList.remove("swiper-slide-active"),i[n].classList.add("swiper-slide-active"),t.activeId=n},t.slideNextManually=function(){t.interVal&&clearInterval(t.interVal),t.slideNext(),t.startSlide()},t.startSlide=function(){t.stopSlide(),i[t.activeId].classList.add("swiper-slide-active"),t.interVal=setInterval(t.slideNext,3e3)},t.stopSlide=function(){t.interVal&&clearInterval(t.interVal),Array.prototype.slice.call(t.swiperSlides).forEach(function(t){t.classList.remove("swiper-slide-active")})}),t},initEvent:function(){$.touchEvent(this.askHintDOM,".swiper-slide-active .hint_list li",function(t){var e=t.target.textContent;$.output(e),this.container.askSIRI(e),this.show(!1)}.bind(this)),$.touchEvent(this.askHintDOM,".btn_change_wrapper .btn_change",function(){this.mySwiper.slideNextManually&&this.mySwiper.slideNextManually()}.bind(this)),$.touchEvent(this.askHintDOM,".btn_close_wrapper .btn_close",function(){this.show(!1)}.bind(this))}};var e=function(){this.from=null==$.getQueryString("from")||"app"==$.getQueryString("from")?"app":"web",this.env=$.getQueryString("env"),this.cardCnt=1,this.cardName="card_1",this.dialogWrapper=document.getElementById("dialog_wrapper"),this.wrapperHeight=$(this.dialogWrapper).height(),this.cardStyle={SIRI_SAY:1,USER_ASK:3},this.netConnector=new NetConnector,this.answerStyle=this.netConnector.answerStyle,this.sageSayCnt=0};e.prototype={init:function(){this.siriAskHint=new t(this),this.addEvent(),this.siriSay("hi"),this.startHeartBeat()},addEvent:function(){$("#input_bar .btn_go").on("click",function(){var t=$("#input_bar input");this.askSIRI(t.val()),t.val(""),t.blur()}.bind(this)),$("#input_bar input").on("keydown",function(t){var e=t||window.event;if(e&&13==e.keyCode){var i=$("#input_bar input");this.askSIRI(i.val()),i.val(""),i.blur()}}.bind(this)),$.touchEvent($("#dialog"),".show_ask_hint",function(){this.siriAskHint.show(!0)}.bind(this)),$.touchEvent($("#dialog"),".active_link",function(t){var e=t.target,i=null;i=e.dataset.question?e.dataset.question:$(e).text(),$.output(i),i&&this.askSIRI(i)}.bind(this)),$('#input_bar input[type="text"]').on("focus",function(t){var e=t.target;setTimeout(function(){e.scrollIntoView(!0)},250)}),$('#input_bar input[type="text"]').on("blur",function(t){window.location.hash=""})},refreshStockQuotationInViewport:function(){updateStockQuotationNode=function(t,e){var i=e.content,n=i.pchg_state,s=i.tradeTime,a=i.tradePrice,o=i.change,r=i.formated_pchg;$.output(n),$.output(s),$.output(a),$.output(o),$.output(r);var c=t.querySelector(".content .price"),d=t.querySelector(".header .trade_time");d&&(d.textContent=s),["up","down","stay"].forEach(function(t){c.classList.remove(t)}),c.classList.add(n);var l=c.querySelector(".trade_price"),h=l.querySelector(".pre"),p=l.querySelector(".now");h.textContent!=a?($(l).one("transitionend",function(t){var e=t.target;h.textContent=p.textContent,e.classList.remove("move_up"),console.log("transitionend")}),p.textContent=a,l.classList.add("move_up")):$.output("the same: trade price.");var v=c.querySelector(".price_change"),u=v.querySelector(".change"),w=u.querySelector(".pre"),S=u.querySelector(".now");w.textContent!=o?($(u).one("transitionend",function(t){var e=t.target;w.textContent=S.textContent,e.classList.remove("move_up"),console.log("transitionend")}),S.textContent=o,u.classList.add("move_up")):$.output("the same: change.");var m=v.querySelector(".pchg"),f=m.querySelector(".pre"),y=m.querySelector(".now");f.textContent!=r?($(m).one("transitionend",function(t){var e=t.target;f.textContent=y.textContent,e.classList.remove("move_up"),console.log("transitionend")}),y.textContent=r,m.classList.add("move_up")):$.output("the same: pchg.")},Array.prototype.slice.call(document.querySelectorAll("#stock_quotation")).forEach(function(t){if(!$.isElementNotInViewport(t)){if(!1 in t.dataset)return;var e=t.dataset.code;this.netConnector.askServer({type:"ASK",question:e},function(e,i){e||i.forEach(function(e){e.style===this.answerStyle.STOCK_QUOTATION&&updateStockQuotationNode(t,e)}.bind(this))}.bind(this))}}.bind(this))},startHeartBeat:function(){var t=0;$.output("start interval"),self.heartBeatInterval=setInterval(function(){if(t+=1,t>6&&(t=0,this.refreshStockQuotationInViewport()),this.sageSayCnt+=1,$.output(this.sageSayCnt),this.sageSayCnt>30){var e=$.toLocaleFormat(new Date,"yyyy-MM-dd");localStorage.dateOfSageSay?e!==localStorage.dateOfSageSay&&(localStorage.dateOfSageSay=e,this.siriSay("hi")):(localStorage.dateOfSageSay=e,this.siriSay("hi")),this.sageSayCnt=0}}.bind(this),1e3)},siriSay:function(t){t&&0!=t.length&&(t=t.trim(),t.length>0&&this.netConnector.askServer({type:"ASK",question:t},function(t,e){t&&(e=[{style:this.answerStyle.PLAIN_TEXT,content:"您好，我是哲，私人理财专家，有关股票证券问题都可以问我。"}]);this.createCard({type:this.cardStyle.SIRI_SAY,content:e});this.scrollAnimate()}.bind(this)))},askSIRI:function(t){if(t&&0!=t.length&&(this.sageSayCnt=0,t=t.trim(),t.length>0)){var e=this.createCard({type:this.cardStyle.USER_ASK,content:t});this.scrollAnimate(),this.netConnector.askServer({type:"ASK",question:t},function(t,i){t&&(i=[{style:this.answerStyle.PLAIN_TEXT,content:"网络好像出了些问题。。。"}]),this.hideLoading(e);var n=i.map(function(t){return this.createAnswerDOM(t)}.bind(this)).join("");e.append($(n)),this.scrollAnimate()}.bind(this))}},createAnswerDOM:function(t){var e="";switch($.output(t),t.style){case this.answerStyle.WAITING:e='<div class="ans_box"><div class="ico_dots dots_loading"><i></i><i></i><i></i></div></div>';break;case this.answerStyle.ASK_HINT:return this.createAnswerDOM({style:this.answerStyle.PLAIN_TEXT,content:t.content})+'<div class="show_ask_hint"><span>你可以这样问我 ></span></div>';case this.answerStyle.PLAIN_TEXT:e='<div class="ans_box">'+t.content+"</div>";break;case this.answerStyle.STOCK_HOT:e='<div class="ans_box" id="stock_hot">'+t.content+"</div>";break;case this.answerStyle.STOCK_FORECAST:e='<div class="ans_box" id="stock_forecast">'+t.content+"</div>";break;case this.answerStyle.STOCK_QUOTATION:var i=t.content;e='<div class="ans_box" id="stock_quotation" data-code="'+i.tradeCode+'"><div class="header"><div class="title">'+i.tradeName+"&nbsp"+i.tradeCode+'</div><div class="status">'+i.stockStatus+"&nbsp&nbsp"+i.tradeDate+'&nbsp&nbsp<span class="trade_time">'+i.tradeTime+'</span></div></div> <div class="content"><div class="price item '+i.pchg_state+'"><div class="trade_price_container"><div class="trade_price"><span class="pre">'+i.tradePrice+'</span><span class="now"></span></div></div><div class="price_change"><div class="change_container"><div class="change"><span class="pre">'+i.change+'</span><span class="now">123</span></div></div><div class="pchg_container"><div class="pchg"><span class="pre">'+i.formated_pchg+'</span><span class="now">234</span></div></div></div></div><div class="item price_show"><div class="sub_item"><div><span>最&nbsp高</span><span>&nbsp'+i.thigh+"</span></div><div><span>今&nbsp开</span><span>&nbsp"+i.topen+'</span></div></div></div><div class="item price_show"><div class="sub_item"><div><span>最&nbsp低</span><span>&nbsp'+i.tlow+"</span></div><div><span>昨&nbsp收</span><span>&nbsp"+i.lclose+'</span></div></div></div></div><div class="footer">'+i.links.map(function(t){return'<div class="active_link">'+t+"</div>"}).join("")+"</div></div>";break;case this.answerStyle.HOT_STOCKS:var i=t.content,n=i.stocks.map(function(t){return'<tr><td><span class="stock_name">'+t.name+'</span>&nbsp<span class="stock_code">'+t.code+"</span></td><td>"+t.topen+'</td><td class="pchg '+t.pchg_state+'">'+t.formated_pchg+"</td></tr>"}).join(""),e='<div class="ans_box" id="hot_stocks"><div class="header">会牛智选</div><div class="content"><div class="title">今日入选（'+i.date+'）</div><table class="stock_list"><tr><th>股票名称</th><th>入选价</th><th>最新涨幅</th></tr>'+n+'</table></div><a class="footer" href="'+i.link.link+'">'+i.link.text+"&nbsp></a></div>"}return'<div class="answer_row"><div class="ans_logo"><i class="benew_logo"></i></div><div class="ans_cont">'+e+"</div></div>"},limitCardNumb:function(){var t=16,e=$(".card");if(e.length>t)for(var i=0,n=e.length-t;i<n;i++)$(e[i]).remove()},createCard:function(t){this.limitCardNumb(),this.cardCnt+=1,this.cardName="card_"+this.cardCnt;var e="",i="";switch(t.type){case this.cardStyle.SIRI_SAY:e="";var n=t.content;i=n.map(function(t){return this.createAnswerDOM({style:t.style,content:t.content})}.bind(this)).join("");break;case this.cardStyle.USER_ASK:e='<div class="ask_row"><span>'+t.content+"</span></div>",i=this.createAnswerDOM({style:this.answerStyle.WAITING})}"selectStockTips"==t.type?(e="",i=this.createAnswerDOM(t)):"onlyAnswer"==t.type&&(e="",i=this.createAnswerDOM(t));var s=$("<div id='"+this.cardName+"' class='card' style='overflow: hidden;'>"+e+i+"</div>");return s.insertBefore($("#bottomDiv")),s},hideLoading:function(t){t.find(".answer_row .ans_cont .ans_box .dots_loading").closest(".answer_row").remove()},scrollAnimate:function(){var t=!1;t?(this.bottomDiv(),this.scrollTopAnimate()):this.scrollBottomAnimate()},bottomDiv:function(){var t=$("#"+this.cardName),e=t.height(),i=this.wrapperHeight-e;i=this.wrapperHeight-e>0?this.wrapperHeight-e:0,$("#bottomDiv").css("height",i)},scrollTopAnimate:function(t){var e=this,i=!0,n=300,s=document.getElementById(this.cardName).offsetTop,a=this.dialogWrapper.scrollTop,o=40,r=(s-a)/n*o,c=function(){Math.abs(a-s)>r?i?(a+=r,e.dialogWrapper.scrollTop=a,window.setTimeout(c,o)):(a=s,i=!1,e.dialogWrapper.scrollTop=a):(a=s,e.dialogWrapper.scrollTop=a,i=!1)};c(),setTimeout(function(){i=!1},n+200)},scrollBottomAnimate:function(){var t=this,e=300,i=40,n=document.getElementById(this.cardName),s=n.offsetTop,a=s+n.clientHeight,o=this.dialogWrapper.scrollTop,r=0,c=o+this.wrapperHeight-r;if(!(c>a)){var d=!0,l=(a-c)/e*i,h=function(){Math.abs(a-c)>l?d?(o+=l,t.dialogWrapper.scrollTop=o,c+=l,window.setTimeout(h,i)):(o=o+a-c,d=!1,t.dialogWrapper.scrollTop=o):(o=o+a-c,t.dialogWrapper.scrollTop=o,d=!1)};h()}},openUrl:function(t){location.href=t.url},createIframe:function(t){var e=t.url,i=$(window).width()-50-26,n=document.createElement("iframe");return n.name=t.cardName,n.setAttribute("style","visibility:hidden;overflow: hidden;"),n.setAttribute("width",i),n.setAttribute("border","none"),n.setAttribute("frameborder","no"),n.setAttribute("src",e),n.onerror=function(){},n},showIframe:function(t){var e=$(window).width()-50-26,i=document.getElementsByName(t.cardName)[0];$(i.contentWindow.document.body).width(e+"px");var n=this;setTimeout(function(){n.updateIframe(t),$(i).attr("style","visibility：visible;overflow: hidden;")},10)},updateIframe:function(t){var e=t.cardName;if(document.getElementsByName(e).length>0){var i=document.getElementsByName(e)[0],n=$(i.contentWindow.document.body)[0].offsetHeight+12,s=$(window).width()-50-26;$(i.contentWindow.document.body).width(s+"px"),$(i).attr("height",n),$(i).attr("width",s),this.bottomDiv(t)}}},benewSIRI=new e,benewSIRI.init(),window.benewSIRI=benewSIRI}();